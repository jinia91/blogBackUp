## 네트워크 계층 개요


2계층까지의 공부를 통해 이더넷 프로토콜과 스위치를 이해했다면 LAN 안에서 노드간 통신이 어떻게 이루어 지는지도 확인했을 것이다.

하지만 위의 규칙만으로는 여러 LAN들이 연결된 WAN, 그리고 인터넷 안에서 데이터 전송이 불가능하다.

스위치의 MAC 테이블은 포트가 연결된 같은 LAN안의 노드만을 기억하므로 저 멀리 다른 네트워크에 속한 노드에게 데이터를 전달하려면

 전세계에 있는 모든 단말에 브로드 캐스트로 데이터를 전송해야하며 이는 물리적으로 불가능한 일이기 때문이다.

![image](https://media.vlpt.us/images/april_5/post/5700820d-ec14-43c2-b801-e5470ea5319d/image.png)

[모두의 네트워크 中 무수히 많은 네트워크간 연결들]

그렇다면 데이터를 어떻게 하면 다른 네트워크의 노드로 전송할 수 있을까?

 **이 네트워크간 통신을 가능하게 하는 것이 네트워크 계층의 역할**이다.

## IP

### 정의와 IP 헤더, IP 패킷
인터넷 프로토콜(Internet Protocol)의 약자로 네트워크 계층의 대표적인 프로토콜이며

>송신 호스트에서 수신 호스트까지의 통신, 즉 보내는 단말에서 받는 단말까지의 통신을 책임진다. 

이를 위해 상위 계층에서 내려온 데이터에 인터넷 프로토콜에서 다루는 데이터들을 **IP헤더**로 부착하여 **IP 패킷** 이라는 단위로 만들고 다루게 된다.

![image](https://media.vlpt.us/images/april_5/post/1654d302-8c60-433e-9108-0788eb522925/image.png)

[모두의 네트워크 中 IP 헤더 구조]


| 명칭 |역할  |
| --- | --- |
| 버전 | 인터넷 프로토콜의 버전(IPv4, IPv6) |
|  헤더길이| 헤더 길이 |
|  서비스 유형| 교환하는 데이터 종료에 따라 지연통신효율, 신뢰성의 우선순위 설정 가능  |
| 전체 패킷 길이 | 헤더 + 데이터의 길이 |
| ID | 상위 계층으로부터 각 IP데이터그램을 분별하기 위한 식별번호<br>(패킷이 단편화되었을때 사용하는 부분) |
| 조각상태 | 데이터그램 분할에 대한 정보 |
|  조각의 위치| 조각 위치를 바이트 단위로 표시 |
| TTL | Time To Live의 약자로 통과가능한 라우터의 남은 수를 나타냄<br> 라우터를 경유할 때마다 이 값이 하나씩 줄어든다(0이 되면 폐기)|
|  프로토콜| 데이터에 포함되는 상위 프로토콜 표시 |
| 헤더 체크섬 | 전송도중 헤더가 손상되지 않았음을 보장하기 위하여 수신된 패킷 내 IP헤더를 자체 검사하는데 사용 |
|  출발지 IP 주소| 발신지의 IP 주소 |
| 목적지 IP 주소 | 수신지의 IP 주소 |


### IP 주소란?

IP 패킷에는 다양한 정보가 존재하지만 그 중 가장 중요한 것을 꼽으라면 바로 IP 주소일 것이다. 

>IP 주소란 컴퓨터 네트워크에서 장치들이 서로를 인식하고 통신을 하기 위해서 사용하는 특수한 번호로

실생활에 비유하면 우편물을 보낼 때 주소같은 개념이다.

여기서 2계층의 MAC 주소와 차이점은 MAC 주소로는 다른 네트워크간 통신을 할 수 없지만, **IP 주소는 다른 네트워크를 식별할 수 있다**는 점이다. 

즉 IP주소는 **어떤 네트워크의 어떤 노드인지** 구분할 수 있도록 하는 주소다.


### IP 주소의 종류와 구조

|  | IPv4 | IPv6 |
| --- | --- | --- |
| 크기 | 32비트 | 128비트 |
| IP 주소 갯수 | 약 43억 | 약 340간(澗) |

#### IPv4 구조

우리가 흔히 접하게 되는 IP주소는 **IPversion4**(IPv4)로서 32비트를 8비트단위로 끊어 10진수로 표시한 형태를 지닌다.

![image](https://media.vlpt.us/images/satoshi25/post/551623c4-e2bb-4d35-b8ea-c988cad396a0/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-09-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%2012.25.51.png)

[2진법으로 표현된 32비트를 1옥텟으로 끊고, 10진법으로 바꿔 읽는다]

그리고 앞서 말한것처럼 IP주소는 **어떤 네트워크의 어떤 노드인지** 구분할 수 있도록 하는 주소이므로 
4개의 옥텟으로 나눈 IP주소를 **네트워크 ID**와 **호스트 ID** 두 블록으로 나눠 읽을 수 있다.

#### IP 주소 :클래스 
IP 주소는 네트워크의 규모에 따라 **네트워크 ID** 길이를 조절하여 표현할 수 있다.

여기서 네트워크 크기는 **클래스** 라는 개념으로 구분한다.


| 클래스 이름 |내용  | 네트워크 ID 길이 |공인 IP 주소의 범위|
| --- | --- | --- |---|
| A | 대규모 네트워크 | 8비트 |1.0.0.0~9.255.255.255<br>11.0.0.0~126.255.255.255|
| B | 중형 네트워크 | 16비트 |128.0.0.0~172.15.255.255<br>172.32.0.0~191.255.255.255|
|  C| 소규모 네트워크 | 24비트 |192.0.0.0~192.167.255.255<br>192.169.0.0~223.255.255.255|
| D | 멀티캐스트 | - |224.0.0.0 ~ 239.255.255.255|
| E | 연구 및 특수용도 | - |240.0.0.0 ~ 255.255.255.255|

>과거에는 IP를 할당할 때 클래스를 나누어서 할당하였는데 인터넷이 점점 발달되고 보편화되면서 IP 주소의 소모가 빨라지자 보다 효율적으로 IP를 사용하기 위해 서브넷의 개념이 생겨났고 이제는 사이더 방식으로 할당한다. <br> 자세한 내용은 아래에서 다루겠다.


#### IPv4는 한정된 자원

IP주소는 32 비트로 표현할 수 있는 숫자, 2^32인 약 43억개가 존재하며 프로토콜을 설계할 당시만 해도 이정도면 충분하다고 여겼다 한다.

 이 주소를 인터넷 할당 번호 관리기관(Internet Assigned Numbers Authority, IANA)이라는 국제기구에서 대륙별로 할당을 해왔으며 

대륙별로 할당된 주소는 국가별로 다시 할당되어 인터넷 서비스 제공자(ISP)에게 위임되고 우리는 ISP에게서  IP주소를 제공받아 네트워크에 접속하였다.

하지만 인터넷이 보급되면서 연결된 노드수는 기하급수적으로 증가했고 IP 주소가 점차 고갈되가면서 이를 해결하기 위한 여러가지 방안이 등장한다.

#### 사설 IP vs 공인 IP

![image](https://media.vlpt.us/images/april_5/post/0b42b0cf-7f02-49ae-bd02-1e0c3aac0121/image.png)


IP 고갈에 대응하기 위해 ISP와 직접 연결되는 네트워크 단위 혹은 네트워크를 묶는 **상위 단위**(라우터)에 **공인 IP**를 할당하고, 그 **하위 단위 노드**에는 **사설 IP주소**를 할당하는 정책이다.

공인 IP를 할당받은 상위 단위는 하위 단말에 네트워크 관리자가 자유롭게 사설 IP 주소를 할당하거나, 라우터의 DHCP 기능을 사용하여 주소를 자동으로 할당하게 된다.

>DHCP(Dynamic Host Configuration Protocol): IP 주소를 자동으로 할당하는 프로토콜

개념이 헤깔릴 수 있는데 실생활에 비유하자면 공인 주소는 대치동 은마아파트, 한남더힐아파트처럼 고유한 주소 개념이라면, 사설주소는 AA동 BB호 처럼 중복되어 사용될수 있는 개념이라고 이해하면 된다.

대치동 은마아파트에도 AA동 BB호가 존재하고, 한남더힐 아파트에도 AA동 BB호가 존재하지만 그 상위의 고유 아파트 이름(공인 IP 주소)때문에 구분될 수 있는것이다.

#### 네트워크 주소와 브로드캐스트 주소
![image](https://media.vlpt.us/images/april_5/post/fe329304-d864-4f96-9c11-019fd8ac8509/image.png)

- 네트워크 주소 : 전체 네트워크에서 작은 네트워크를 식별하는데 사용
 - 브로드캐스트 주소 : 네트워크에 있는 컴퓨터나 장비 모두에게 한번에 데이터를 전송하는데 사용되는 전용 IP 주소
 - 네트워크 주소와 브로드캐스트 주소는 개별단말에 할당될 수 없다.

## 서브넷

### 서브넷? 서브넷팅? CIDR?

IP 주소는 A, B, C, D, E 클래스로 나누어져 있고, 일반적으로 사용되는 IP 주소는 A, B, C로 나뉘어져 있다.

A 클래스 네트워크는 호스트 ID가 24비트이므로, 하나의 네트워크에 1677만 7214개의 IP 주소를 사용한다.

만약 이 상태에서 브로드캐스트 패킷을 전송한다면 A클래스 네트워크의 모든 단말로 패킷이 전송되므로 엄청난 네트워크 트래픽이 발생하게 된다.

만약 A클래스의 특정 IP 주소 그룹에만 브로드캐스트를 하고 싶다면 어떻게 해야할까?

이러한 대규모 네트워크를 논리적인 작은 네트워크 단위로 분할하는 것을 **서브넷팅**, 분할된 네트워크를 **서브넷**이라고 부르며 

기존의 클래스 분류체계를 사실상 형해화하는 새로운 할당방식이기 떄문에 사이더(Classless inter-Domain Routing, CIDR)라고도 불린다.

### 서브네팅 방법과 표기법
![image](https://media.vlpt.us/images/april_5/post/8616b52a-554c-4f97-aa83-69fa9dd11ef6/image.png)

호스트를 나타내는 호스트 ID의 비트를 빌려서 서브넷을 나타내게 된다.

이때, IP 주소의 클래스가 ABC중 무엇인지를 구분하기 위해 **서브넷 마스크** 라는 비트마스크를 사용하며, 이를 프리픽스 표기법으로 나타낸다.

|  | 서브넷 마스크(비트)| 서브넷 마스크 | 프리픽스 표기 |
| --- | --- | --- | --- |
| A |  11111111 00000000 00000000 00000000|255.0.0.0  | /8 |
| B | 11111111 11111111 00000000 00000000 | 255.255.0.0 | /16 |
| C | 11111111 11111111 11111111 00000000| 255.255.255.0 | /24 |

위의 표는 서브네팅을 하기전 클래스별 표준적인 서브넷 마스크이며 만약 A클래스 네트워크를 호스트 ID 3자리 비트를 빌려 서브네팅을 한다면

| 서브넷 마스크(비트) | 서브넷마스크 | 프리픽스 표기|
| --- | --- | --- | 
| 11111111 11100000 00000000 00000000 | 255.224.0.0 | /11 | 

로 표현가능해진다.

요약하면 기존의 IP주소가 네트워크 ID + 호스트 ID 구조였다면 서브네팅을 통해 네트워크ID + 서브넷ID + 호스트ID로 네트워크를 더욱 쪼개어 표현할 수 있게된 것이다.


## 라우터(router), L3

>서로 다른 네트워크를 연결하는 장치, 혹은 **네트워크를 분리**하는 장치

![image](https://media.vlpt.us/images/april_5/post/bd201dcb-b578-4a47-b2d2-9b39a86678b6/image.png)

2계층에서 살펴본 스위치(L2 스위치) 그리고 허브만 있는 네트워크는 모든 노드와 스위치가 몇개로 연결되어 있든 동일한 네트워크에 속한다.

하지만 라우터를 사용하면 네트워크를 분할할 수 있다.

### 라우팅

> 경로 정보를 기반으로 현재의 네트워크에서 다른 네트워크로 최적의 경로를 통해 데이터를 전송하는 기술

- 라우터에는 **라우팅 테이블**이라는 경로 정보가 등록되어있는 테이블이 존재한다.

- 라우터는 **라우팅 프로토콜**을 사용하여 라우터간 경로정보를 서로 교환하며 테이블 정보를 자동 갱신 작성하고

해당 테이블을 사용해 데이터 전송의 최적 경로를 찾는 라우팅을 수행한다.

- 대표적인 라우팅 프로토콜에는 RIP, OSPF, BGP 등이 있다.

### 라우터를 통한 데이터 전송 과정

![image](https://media.vlpt.us/images/april_5/post/0f93f105-3b04-46fc-aefc-40907a6e6355/image.png)

[모두의 네트워크 책에 나온 예시로 알아보자]

**1번 노드에서 다른 네트워크인 6번 노드로 데이터 전송하기**
1. 1번 노드의 기본 게이트웨이를 라우터의 IP 주소로 설정
    - 1번노드는 다른 네트워크로 데이터를 보낼 때 어디로 전송해야하는지 모르므로 네트워크의 출입구를 지정하고 상위 라우터로 데이터 전송
2. 라우터는 라우팅 테이블을 참조해 라우팅하여 데이터 전달


## 요약

- 전송 단위 : 패킷
- 프로토콜 : IP, ICMP, ARP, RIP, IGMP 등
- 데이터 전송시 경로 제어 및 인터 네트워킹
- 최적 경로 선택(라우팅)
- 관련 장치 : 라우터


## References
- [제로베이스, 컴퓨터공학 전공자 따라잡기](https://zero-base.co.kr/)
- [미즈구치 카츠야, 모두의 네트워크, 길벗](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9791160505030)
- [https://hwannny.tistory.com/86](https://hwannny.tistory.com/86)