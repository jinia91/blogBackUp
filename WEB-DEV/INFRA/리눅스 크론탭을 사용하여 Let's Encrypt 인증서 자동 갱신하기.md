# Goal

현재 블로그 프로젝트는 Let's Encrypt 인증서로 https 프로토콜을 사용하고 있으며, Let's Encrypt는 인증서 만료기간이 3개월이고, 인증서의 갱신방법은 수동인 상태이다.

따라서 아래의 목표를 가지고 학습, 포스팅을 하고자 한다.

- https와 ssl, ssl 인증서의 개념에대해 익히기
- Let's Encrypt 인증서 갱신 방법 학습
- Let's Encrypt 를 크론탭을 사용해 자동 갱신 시스템 구축

# Let's Encrypt
## HTTPS와 SSL
### HTTPS VS HTTP
HTTP(Hypertext Transfer Protocol)는 Hypertext 인 HTML을 전송하기 위한 통신규약을 의미한다. 

HTTPS에서 마지막의 S는 Over Secure Socket Layer의 약자로 Secure라는 말을 통해서 알 수 있듯이 보안이 강화된 HTTP라는 것을 짐작할 수 있다. 

HTTP는 암호화되지 않은 방법으로 데이터를 전송하기 때문에 서버와 클라이언트가 주고 받는 메시지를 감청하는 것이 매우 쉽다. 

예를들어 로그인을 위해서 서버로 비밀번호를 전송하거나, 또는 중요한 기밀 문서를 열람하는 과정에서 악의적인 감청이나 데이터의 변조등이 일어날 수 있다는 것이다. 

이를 보안한 것이 HTTPS다.

### HTTPS와 SSL, TLS

네스케이프에 의해 SSL(보안 소켓 레이어/Secure Sockets Layer)이 발명되었고, 이것이 점차 폭넓게 사용되다가 표준화 기구인 IETF의 관리로 변경되면서 TLS(Transport Layer Security)라는 이름으로 바뀌었다.

따라서 SSL = TLS이며, TLS 1.0은 SSL 3.0을 계승한다. 하지만 TLS라는 이름보다 SSL이라는 이름이 훨씬 많이 사용되고 있다.

HTTPS는 이 TLS 프로토콜 위에서 돌아가는 HTTP 프로토콜을 의미한다.

## SSL 프로토콜의 핵심과 동작 방식

### SSL 프로토콜의 핵심 보안 기능

TLS/SSL은 클라이언트/서버 응용 프로그램이 네트워크로 통신을 하는 과정에서 도청, 간섭, 위조를 방지하기 위해서 설계되었다. 

그리고 암호화를 해서 최종단의 인증, 통신 기밀성을 유지시켜준다.

이때 클라이언트와 서버간 보안 통신 수단으로 `SSL 인증서`를 사용한다.

### SSL 디지털 인증서란?

SSL 인증서는 클라이언트와 서버간의 통신을 제3자가 보증해주는 전자화된 문서다. 

클라이언트가 서버에 접속한 직후에 서버는 클라이언트에게 이 인증서 정보를 전달한다. 클라이언트는 이 인증서 정보가 신뢰할 수 있는 것인지를 검증 한 후에 다음 절차를 수행하게 된다. 

**SSL 인증서를 사용했을때 이점**

- 통신 내용이 공격자에게 노출되는 것을 막을 수 있다. 
- 클라이언트가 접속하려는 서버가 신뢰 할 수 있는 서버인지를 판단할 수 있다.
- 통신 내용의 악의적인 변경을 방지할 수 있다. 

### 동작 방식

1. 클라이언트가 웹브라우저로 사이트에 접속 상황!
2. 웹 서버는 먼저 클라이언트의 웹 브라우저에 가지고있는 SSL 인증서를 제출
3. 웹 브라우저는 이미 가지고 있는 인증서 목록에서 해당 인증기관(CA) 서치
4. 인증서를 찾으면 인증서에 내장되있는 공개키를 추출
5. 추출한 공개키를 이용해 웹 서버에서 받은 인증서를 복호화해서 확인
6. 인증서 진위가 확인되면 클라이언트는 접속하려는 서버가 신뢰할 수 있는 서버인지 판단 완료
7. 웹 브라우저는 서버와 통신시 실제 데이터의 암호화에 사용할 대칭키를 생성
8. 인증서에서 꺼낸 웹 서버측의 공개키로 생성한 대칭키를 암호화해서 웹 서버로 전송
9. 웹 서버는 자신이 가지고 있던 개인키로 웹 브라우저가 보내온 암호화된 대칭키를 복호화
10. 클라이언트와 서버의 세션 형성,  대칭키를 이용해 데이터를 암호화해서 주고받기

## 그렇다면 Let's Encrypt는 무엇인가?

HTTPS 프로토콜은 세상에 등장한 직후, 기존 HTTP의 보안 취약점을 보안한 안전한 보안 프로토콜로서 많은 주목을 받았다.

하지만 서버가 HTTPS 프로토콜을 이용하기 위해서는 SSL 인증서 발급을 받아야 하며, SSL 인증서는 공인된 인증기관(CA)에서만 발급받을 수 있었다.

그리고 해당 기관 대부분은 SSL 인증서를 유료로 발급하고 절차가 복잡했기 때문에, HTTPS 프로토콜의 실질적인 보급은 상당히 느렸다.

여기서 등장한 것이 바로 Let's Encrypt 프로젝트다.

Let's Encrypt는 보안 웹사이트를 위한 인증서의 수동 생성, 유효성 확인, 디지털 서명, 설치, 갱신 등 종전의 복잡한 과정을 없애주는 자동화된 프로세스를 통해 전송 계층 보안(TLS) 암호화를 위해 **무료** X.509 인증서를 제공하는 인증 기관이다.

무료이기 때문에 신뢰성을 의심할 수도 있으나,  Let's Encrypt의 주요 스폰서들은 전자 프런티어 재단(EFF), 모질라 재단, OVH, 아카마이, 시스코 시스템즈, IdenTrust, 미시간 대학교, 스탠퍼드 법학대학원, 리눅스 재단 등이 있으며,

2015년 10월경 모든 주요 브라우저에서 신뢰를 인증받았으므로 우리는 안심하고 사용할 수 있다!


#  Let's Encrypt 자동갱신 시스템 구축하기

## 수동 갱신

Let's Encrypt 인증서는 만료기간이 3개월이기 때문에, 3개월마다 인증서를 새로 갱신해줘야 한다.

### 인증서 만료일 확인하기

`sudo letsencrypt certificates`
![첨부 이미지](https://github.com/jinia91/blogBackUp/blob/main/img/b683dd66-6511-47c6-9f64-5f038c7b53b9.png?raw=true)

### 인증서 수동 갱신하기

`sudo letsencrypt renew`

해당 명령어를 통해 수동 갱신이 가능하다.

## 자동 갱신

자동 갱신을 위해서는 **배치작업**을 해야하는데 리눅스에서는`crontab`을 사용하면 손쉽게 배치작업 스크립트를 작성할 수 있다. 

### cron 표현식

crontab은 특정 시간이나 날짜를 설정하여, 반복되는 작업을 자동화할 수 있다.

- 유닉스 / 리눅스 크론 표현식
    
| 순서 | 필드 이름 | 허용 값 |
| --- | --- | --- |
| 1 | 분 | 0~59, 특수문자 |
| 2 | 시간 | 0~23, 특수문자 |
|  3|  일| 1~31, 특수문자 |
| 4 | 월 | 1~12, JAN~DEC, 특수문자 |
|  5| 요일 | 1~7, SUN-SAT, 특수문자 |
| 6 | 연도(생략가능) | 1970~2099. 특수문자 |

- 특수 문자 의미
    
| 기호 | 의미 |
| --- | --- |
| * | 모든 수 |
|  ?| 해당 항목을 미사용 |
| - | 기간 설정 |
| . | 특정 기간 설정 |
|  /| 시작 시간과 반복간격 설정 |
| L | 마지막 기간에 동작 |
| W | 가장 가까운 평일에 동작 |
| # | 몇 번째주, 요일 설정

**실제 예시**

> \* * * * * {명령어}

- 매 10분마다 해당 스크립트 실행
> */10 * * * * /home/user/script.sh

### 인증서 자동 갱신 크론탭 설정하기
 
1. `sudo service crond start` 크론탭 서비스 시작
2. `crontab -e` 크론탭 작성 vi 진입
![첨부 이미지](https://github.com/jinia91/blogBackUp/blob/main/img/21b62f45-ff0b-41f2-883e-9063a648c795.png?raw=true)

3. `10 5 * * 1 /usr/bin/letsencrypt renew` 입력 (매주 월요일 새벽 5시 10분에 인증서를 갱신한다는 의미)
4. `:wq`로 저장
5. `crontab -l`로 확인해보기
 ![첨부 이미지](https://github.com/jinia91/blogBackUp/blob/main/img/4fbb2b71-bd4d-4d23-8e2c-f4b436209cf1.png?raw=true)
[등록 완료!]
